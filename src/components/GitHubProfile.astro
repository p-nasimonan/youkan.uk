---
import { readFileSync } from 'fs';
import { css } from '@styles/css';
import 'github-markdown-css/github-markdown-light.css';
import { unified } from 'unified';
import remarkParse from 'remark-parse';
import remarkGfm from 'remark-gfm';
import remarkRehype from 'remark-rehype';
import rehypeHighlight from 'rehype-highlight';
import rehypeStringify from 'rehype-stringify';

interface Props {
  className?: string;
}

interface ProfileMeta {
  title: string;
  description?: string;
  updatedAt: string;
  source: string;
}

interface ParsedProfile {
  content: string;
  meta: ProfileMeta;
}

const { className } = Astro.props;

const defaultMeta: ProfileMeta = {
  title: 'GitHubãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«',
  updatedAt: new Date().toISOString(),
  source: 'fallback'
};

function parseMarkdownFile(filePath: string): ParsedProfile {
  try {
    const fileContent = readFileSync(filePath, 'utf8');
    
    // ãƒ•ãƒ­ãƒ³ãƒˆãƒã‚¿ãƒ¼ã¨ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³æœ¬æ–‡ã‚’åˆ†é›¢
    const frontmatterMatch = fileContent.match(/^---\n([\s\S]*?)\n---\n([\s\S]*)$/);
    
    if (frontmatterMatch) {
      const frontmatterText = frontmatterMatch[1];
      const content = frontmatterMatch[2];
      
      const meta: ProfileMeta = { ...defaultMeta };
      
      // ãƒ•ãƒ­ãƒ³ãƒˆãƒã‚¿ãƒ¼è§£æ
      frontmatterText.split('\n').forEach((line: string) => {
        const colonIndex = line.indexOf(':');
        if (colonIndex === -1) return;
        
        const key = line.substring(0, colonIndex).trim();
        const value = line.substring(colonIndex + 1).trim().replace(/^["']|["']$/g, '');
        
        switch (key) {
          case 'title':
            meta.title = value;
            break;
          case 'description':
            meta.description = value;
            break;
          case 'updatedAt':
            meta.updatedAt = value;
            break;
          case 'source':
            meta.source = value;
            break;
        }
      });
      
      return { content, meta };
    } else {
      return { content: fileContent, meta: defaultMeta };
    }
  } catch (error) {
    console.warn('GitHubãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error instanceof Error ? error.message : 'Unknown error');
    
    const fallbackContent = `# ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«

GitHubãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚
\`npm run fetch:github\` ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

- GitHub: [p-nasimonan](https://github.com/p-nasimonan)
`;
    
    return { content: fallbackContent, meta: defaultMeta };
  }
}

// unified/remark/rehypeã‚’ä½¿ã£ãŸãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å‡¦ç†
async function markdownToHtml(markdown: string): Promise<string> {
  try {
    const result = await unified()
      .use(remarkParse) // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚’parseã™ã‚‹
      .use(remarkGfm)   // GitHub Flavored Markdownå¯¾å¿œ
      .use(remarkRehype) // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ASTã‹ã‚‰HTMLASTã«å¤‰æ›
      .use(rehypeHighlight) // ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ãƒã‚¤ãƒ©ã‚¤ãƒˆ
      .use(rehypeStringify) // HTMLã«å¤‰æ›
      .process(markdown);
    
    return String(result);
  } catch (error) {
    console.error('ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
    return `<p>ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error instanceof Error ? error.message : 'Unknown error'}</p>`;
  }
}

const { content, meta } = parseMarkdownFile('./src/content/github-profile.md');
const htmlContent = await markdownToHtml(content);
---

<section class={`${css({
  padding: '2rem',
  backgroundColor: 'blue.50',
  borderRadius: 'lg',
  border: '2px solid',
  borderColor: 'blue.200'
})} ${className || ''}`}>
  <div class={css({
    display: 'flex',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: '1rem'
  })}>
    <h2 class={css({
      fontSize: '2xl',
      fontWeight: 'bold',
      color: 'blue.800'
    })}>
      ğŸ“– {meta.title}
    </h2>
    
    <div class={css({
      fontSize: 'sm',
      color: 'blue.600'
    })}>
      æœ€çµ‚æ›´æ–°: {new Date(meta.updatedAt).toLocaleDateString('ja-JP')}
    </div>
  </div>

  <!-- GitHub Markdown CSS ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨ -->
  <div class="markdown-body">
    <div 
      class={css({
        fontSize: '14px',
        lineHeight: '1.6',
        '& img': {
          maxWidth: '100%',
          height: 'auto',
          borderRadius: 'md',
          display: 'block',
          margin: '1rem auto'
        },
        '& .markdown-body': {
          boxSizing: 'border-box',
          minWidth: '200px',
          maxWidth: '980px',
          margin: '0 auto'
        }
      })}
      set:html={htmlContent}
    />
  </div>
  
  {meta.source !== 'fallback' && (
    <div class={css({
      marginTop: '1rem',
      padding: '1rem',
      backgroundColor: 'blue.100',
      borderRadius: 'md',
      fontSize: 'sm',
      color: 'blue.600'
    })}>
      <p>
        ğŸ”— <a href="https://github.com/p-nasimonan/p-nasimonan" target="_blank" rel="noopener noreferrer" class={css({ color: 'blue.600', textDecoration: 'underline' })}>
          GitHubãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
        </a> ã‹ã‚‰è‡ªå‹•å–å¾—
      </p>
    </div>
  )}
</section>
---
