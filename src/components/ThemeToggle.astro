---
// ThemeToggle.astro - ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
import { css } from '@styles/css';

const buttonStyles = css({
  position: 'fixed',
  top: '1rem',
  right: '1rem',
  zIndex: 1000,
  width: '3rem',
  height: '3rem',
  borderRadius: '50%',
  border: 'none',
  cursor: 'pointer',
  background: 'linear-gradient(135deg, #ff6b35, #ffa500)',
  boxShadow: '0 4px 15px rgba(255, 107, 53, 0.3)',
  transition: 'all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94)',
  display: 'flex',
  alignItems: 'center',
  justifyContent: 'center',
  fontSize: '1.2rem',
  
  // ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ
  '@media (max-width: 768px)': {
    width: '2.5rem',
    height: '2.5rem',
    fontSize: '1rem',
    top: '0.75rem',
    right: '0.75rem',
  },
  
  // ãƒ›ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
  _hover: {
    transform: 'scale(1.1)',
    boxShadow: '0 6px 20px rgba(255, 107, 53, 0.4)',
  },
  
  // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ«
  _dark: {
    background: 'linear-gradient(135deg, #4f46e5, #7c3aed)',
    boxShadow: '0 4px 15px rgba(79, 70, 229, 0.3)',
    
    _hover: {
      boxShadow: '0 6px 20px rgba(79, 70, 229, 0.4)',
    }
  }
});

const iconStyles = css({
  transition: 'all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
  filter: 'drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1))',
});

const rotateAnimation = css({
  animation: 'rotate 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94)',
});
---

<button 
  class={buttonStyles} 
  id="theme-toggle"
  aria-label="ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ"
  title="ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ"
>
  <span class={iconStyles} id="theme-icon">â˜€ï¸</span>
</button>

<script>
  // ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆã®å‡¦ç†
  class ThemeToggle {
    private button: HTMLButtonElement;
    private icon: HTMLSpanElement;
    private currentTheme: 'light' | 'dark';

    constructor() {
      this.button = document.getElementById('theme-toggle') as HTMLButtonElement;
      this.icon = document.getElementById('theme-icon') as HTMLSpanElement;
      this.currentTheme = this.getInitialTheme();
      
      this.init();
    }

    private getInitialTheme(): 'light' | 'dark' {
      // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰è¨­å®šã‚’å–å¾—
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'dark' || savedTheme === 'light') {
        return savedTheme;
      }
      
      // ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã‚’ç¢ºèª
      if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        return 'dark';
      }
      
      return 'light';
    }

    private init() {
      // åˆæœŸãƒ†ãƒ¼ãƒã‚’é©ç”¨
      this.applyTheme(this.currentTheme, false);
      
      // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
      this.button.addEventListener('click', () => this.toggleTheme());
      
      // ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã®å¤‰æ›´ã‚’ç›£è¦–
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
        if (!localStorage.getItem('theme')) {
          this.currentTheme = e.matches ? 'dark' : 'light';
          this.applyTheme(this.currentTheme, true);
        }
      });
    }

    private toggleTheme() {
      this.currentTheme = this.currentTheme === 'light' ? 'dark' : 'light';
      this.applyTheme(this.currentTheme, true);
      
      // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
      localStorage.setItem('theme', this.currentTheme);
    }

    private applyTheme(theme: 'light' | 'dark', animate: boolean) {
      const html = document.documentElement;
      
      if (animate) {
        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãã§åˆ‡ã‚Šæ›¿ãˆ
        this.animateTransition();
      }
      
      if (theme === 'dark') {
        html.classList.add('dark');
        this.icon.textContent = 'ğŸŒ™';
        this.button.setAttribute('aria-label', 'ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ');
        this.button.setAttribute('title', 'ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ');
      } else {
        html.classList.remove('dark');
        this.icon.textContent = 'â˜€ï¸';
        this.button.setAttribute('aria-label', 'ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ');
        this.button.setAttribute('title', 'ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ');
      }
    }

    private animateTransition() {
      // èƒŒæ™¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®è¦ç´ ã‚’ä½œæˆ
      this.createBackgroundAnimation();
      
      // ãƒœã‚¿ãƒ³ã‚¢ã‚¤ã‚³ãƒ³ã®å›è»¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
      this.icon.style.transform = 'rotate(360deg)';
      
      setTimeout(() => {
        this.icon.style.transform = 'rotate(0deg)';
      }, 600);
    }

    private createBackgroundAnimation() {
      // æ—¢å­˜ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¦ç´ ãŒã‚ã‚Œã°å‰Šé™¤
      const existingAnimation = document.querySelector('.theme-transition-overlay');
      if (existingAnimation) {
        existingAnimation.remove();
      }

      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’ä½œæˆ
      const overlay = document.createElement('div');
      overlay.className = 'theme-transition-overlay';
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        pointer-events: none;
        z-index: 999;
        overflow: hidden;
      `;

      // å¤ªé™½ã¨æœˆã®è¦ç´ ã‚’ä½œæˆ
      const sun = document.createElement('div');
      const moon = document.createElement('div');
      
      const celestialBodyStyle = `
        position: absolute;
        width: 8rem;
        height: 8rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
        top: 20%;
        transition: transform 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      `;

      sun.style.cssText = celestialBodyStyle + `
        background: radial-gradient(circle, #ffeb3b, #ff9800);
        box-shadow: 0 0 30px rgba(255, 152, 0, 0.6), 0 0 60px rgba(255, 152, 0, 0.4);
        left: ${this.currentTheme === 'light' ? '100vw' : '-10rem'};
      `;
      sun.textContent = 'â˜€ï¸';

      moon.style.cssText = celestialBodyStyle + `
        background: radial-gradient(circle, #e3f2fd, #90caf9);
        box-shadow: 0 0 30px rgba(144, 202, 249, 0.6), 0 0 60px rgba(144, 202, 249, 0.4);
        left: ${this.currentTheme === 'dark' ? '100vw' : '-10rem'};
      `;
      moon.textContent = 'ğŸŒ™';

      // é›²ã®è¦ç´ ã‚’è¿½åŠ 
      const clouds = this.createClouds();
      
      overlay.appendChild(sun);
      overlay.appendChild(moon);
      clouds.forEach(cloud => overlay.appendChild(cloud));
      document.body.appendChild(overlay);

      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
      setTimeout(() => {
        if (this.currentTheme === 'dark') {
          // ãƒ©ã‚¤ãƒˆâ†’ãƒ€ãƒ¼ã‚¯: å¤ªé™½ãŒå·¦ã«å»ã‚Šã€æœˆãŒå³ã‹ã‚‰æ¥ã‚‹
          sun.style.transform = 'translateX(-120vw)';
          moon.style.transform = 'translateX(calc(-100vw + 50vw - 4rem))';
        } else {
          // ãƒ€ãƒ¼ã‚¯â†’ãƒ©ã‚¤ãƒˆ: æœˆãŒå·¦ã«å»ã‚Šã€å¤ªé™½ãŒå³ã‹ã‚‰æ¥ã‚‹
          moon.style.transform = 'translateX(-120vw)';
          sun.style.transform = 'translateX(calc(-100vw + 50vw - 4rem))';
        }

        // é›²ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        clouds.forEach((cloud, index) => {
          cloud.style.transform = `translateX(${100 + index * 50}vw)`;
        });
      }, 100);

      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’å‰Šé™¤
      setTimeout(() => {
        overlay.remove();
      }, 1400);
    }

    private createClouds() {
      const clouds = [];
      const cloudCount = 3;
      
      for (let i = 0; i < cloudCount; i++) {
        const cloud = document.createElement('div');
        cloud.style.cssText = `
          position: absolute;
          font-size: ${1.5 + Math.random() * 1}rem;
          opacity: 0.7;
          top: ${10 + Math.random() * 60}%;
          left: ${-20 - i * 30}vw;
          transition: transform 1.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
          transition-delay: ${i * 0.1}s;
        `;
        cloud.textContent = 'â˜ï¸';
        clouds.push(cloud);
      }
      
      return clouds;
    }
  }

  // DOMãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã‚‰åˆæœŸåŒ–
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => new ThemeToggle());
  } else {
    new ThemeToggle();
  }

  // View Transitions APIå¯¾å¿œï¼ˆãƒšãƒ¼ã‚¸é·ç§»æ™‚ã®çŠ¶æ…‹ç¶­æŒï¼‰
  document.addEventListener('astro:page-load', () => {
    new ThemeToggle();
  });
</script>

<style>
  /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®ã‚­ãƒ¼ãƒ•ãƒ¬ãƒ¼ãƒ  */
  @keyframes rotate {
    0% {
      transform: rotate(0deg);
    }
    50% {
      transform: rotate(180deg) scale(1.2);
    }
    100% {
      transform: rotate(360deg);
    }
  }

  /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ç”¨ã®CSSå¤‰æ•° */
  :global(html.dark) {
    color-scheme: dark;
  }

  :global(html.dark body) {
    background: linear-gradient(135deg, #0f0f23, #1a1a2e);
    color: #e2e8f0;
  }

  :global(html:not(.dark) body) {
    background: linear-gradient(135deg, #fef9e7, #fff5d6);
    color: #1a1a1a;
  }

  /* ã‚¹ãƒ ãƒ¼ã‚ºãªèƒŒæ™¯è‰²ã®å¤‰åŒ– */
  :global(body) {
    transition: background 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94), color 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }

  /* èƒŒæ™¯ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¼·åŒ– */
  :global(html.dark body) {
    background: linear-gradient(135deg, #0c1445 0%, #1a1a2e 50%, #16213e 100%);
  }

  :global(html:not(.dark) body) {
    background: linear-gradient(135deg, #fef9e7 0%, #fff5d6 50%, #f0f8ff 100%);
  }
</style>