---
// IntroAnimation.astro - å°å…¥ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
import { css } from '@styles/css';
import SelectionScreen from './SelectionScreen.astro';

export interface SelectionOption {
  id: string;
  title: string;
  description: string;
  backgroundImage: string;
  href: string;
}

interface Props {
  options: SelectionOption[];
}

const { options } = Astro.props;

// ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¦ç´ ã®ã‚¹ã‚¿ã‚¤ãƒ«
const introContainer = css({
  position: 'fixed',
  top: 0,
  left: 0,
  width: '100vw',
  height: '100vh',
  display: 'flex',
  flexDirection: 'column',
  alignItems: 'center',
  justifyContent: 'center',
  background: '#667eea',
  zIndex: 1000,
  opacity: 1,
  transition: 'opacity 0.6s ease-out'
});


const itemContainer = css({
  position: 'relative',
  width: '400px',
  height: '300px',
  margin: '0 auto'
});

// ä¸­å¿ƒã‹ã‚‰é£›ã³å‡ºã™ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¹ã‚¿ã‚¤ãƒ«  
const floatingItem = css({
  position: 'absolute',
  fontSize: '5rem',
  opacity: 0,
  transform: 'scale(0) translate(-50%, -50%)',
  left: '50%',
  top: '50%',
  transformOrigin: 'center',
  filter: 'drop-shadow(0 4px 12px rgba(0,0,0,0.3))',
  cursor: 'pointer',
  transition: 'transform 0.3s ease',
  
  '&.avatar': {
    animation: 'popOut 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) 0.2s forwards, floatGentle 2s ease-in-out 1s infinite'
  },
  '&.tea': {
    animation: 'popOut 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) 0.4s forwards, floatGentle 2s ease-in-out 1.2s infinite'
  },
  '&.youkan': {
    animation: 'popOut 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) 0.6s forwards, floatGentle 2s ease-in-out 1.4s infinite'
  },
  
  _hover: {
    transform: 'scale(1.05) translate(-50%, -50%)'
  }
});

const skipButton = css({
  position: 'fixed',
  bottom: '2rem',
  right: '2rem',
  padding: '0.5rem 1rem',
  backgroundColor: 'rgba(255,255,255,0.1)',
  backdropFilter: 'blur(10px)',
  border: '1px solid rgba(255,255,255,0.2)',
  borderRadius: '999px',
  color: 'white',
  fontSize: 'xs',
  fontWeight: 'medium',
  cursor: 'pointer',
  opacity: 0,
  animation: 'fastFadeIn 0.3s ease-out 0.5s forwards',
  transition: 'all 0.2s ease',
  
  _hover: {
    backgroundColor: 'rgba(255,255,255,0.2)',
    transform: 'scale(1.05)'
  },
  
  _dark: {
    backgroundColor: 'rgba(255,255,255,0.08)',
    border: '1px solid rgba(255,255,255,0.1)',
    _hover: {
      backgroundColor: 'rgba(255,255,255,0.15)'
    }
  }
});
---

<div id="intro-animation" class={introContainer}>
  <div class={itemContainer}>
    <!-- ã‚¢ãƒã‚¿ãƒ¼ -->
    <div class={`${floatingItem} avatar`} style="left: 25%; top: 35%;">
      ğŸ‘¤
    </div>
    
    <!-- ç´…èŒ¶ -->
    <div class={`${floatingItem} tea`} style="left: 75%; top: 35%;">
      ğŸ«–
    </div>
    
    <!-- ã‚ˆã†ã‹ã‚“ -->
    <div class={`${floatingItem} youkan`} style="left: 50%; top: 65%;">
      ğŸ 
    </div>
  </div>
  
  <button id="skip-intro" class={skipButton}>
    ã‚¹ã‚­ãƒƒãƒ—
  </button>
</div>

<!-- ãƒ¡ã‚¤ãƒ³ã®é¸æŠç”»é¢ï¼ˆåˆæœŸã¯éè¡¨ç¤ºï¼‰ -->
<div id="selection-screen" style="opacity: 0; transform: translateY(30px); transition: opacity 0.6s ease-out, transform 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);">
  <SelectionScreen options={options} />
</div>

<script>
  class IntroAnimationController {
    private introElement: HTMLElement;
    private selectionElement: HTMLElement;
    private skipButton: HTMLElement;
    private animationStarted = false;
    private hasShownIntro = false;

    constructor() {
      this.introElement = document.getElementById('intro-animation')!;
      this.selectionElement = document.getElementById('selection-screen')!;
      this.skipButton = document.getElementById('skip-intro')!;
      
      this.init();
    }

    private init() {
      // ãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯æ¤œå‡ºï¼šnavigation timing APIã‚’ä½¿ç”¨
      const shouldSkipIntro = this.shouldSkipIntroAnimation();
      
      if (shouldSkipIntro) {
        // ãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯æ™‚ã¯å³åº§ã«ãƒ¡ã‚¤ãƒ³ç”»é¢ã‚’è¡¨ç¤º
        this.showMainScreen();
        return;
      }
      
      // åˆå›ã¾ãŸã¯ãƒšãƒ¼ã‚¸é–“é·ç§»æ™‚ã¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ
      this.hasShownIntro = false;
      
      // ã‚¹ã‚­ãƒƒãƒ—ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
      this.skipButton.addEventListener('click', () => this.skipIntro());
      
      // è‡ªå‹•çš„ã«ãƒ¡ã‚¤ãƒ³ç”»é¢ã«é·ç§»ï¼ˆ2ç§’å¾Œï¼‰
      setTimeout(() => {
        if (!this.animationStarted) {
          this.showMainScreen();
        }
      }, 2000);
    }

    private shouldSkipIntroAnimation(): boolean {
      const currentTime = Date.now();
      const lastVisit = sessionStorage.getItem('last-intro-visit');
      const visitCount = sessionStorage.getItem('intro-visit-count') || '0';
      
      // ãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯æ¤œå‡ºï¼šçŸ­æ™‚é–“ã§ã®å†è¨ªå•ã‹ã¤è¨ªå•å›æ•°ãŒ1ä»¥ä¸Š
      if (lastVisit && parseInt(visitCount) > 0) {
        const timeDiff = currentTime - parseInt(lastVisit);
        
        // 30ç§’ä»¥å†…ã®å†è¨ªå•ã¯ãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯æ‰±ã„
        if (timeDiff < 30000) {
          return true;
        }
      }
      
      // ãƒšãƒ¼ã‚¸è¡¨ç¤ºã®ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆæ¤œå‡º
      if (document.referrer && document.referrer.includes(window.location.origin)) {
        // åŒã˜ã‚µã‚¤ãƒˆå†…ã‹ã‚‰ã®é·ç§»ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯ã®å¯èƒ½æ€§ãŒé«˜ã„ï¼‰
        const timeSinceLastVisit = lastVisit ? currentTime - parseInt(lastVisit) : Infinity;
        if (timeSinceLastVisit < 60000) { // 1åˆ†ä»¥å†…
          return true;
        }
      }
      
      // è¨ªå•æƒ…å ±ã‚’æ›´æ–°
      sessionStorage.setItem('last-intro-visit', currentTime.toString());
      sessionStorage.setItem('intro-visit-count', (parseInt(visitCount) + 1).toString());
      
      return false;
    }

    private skipIntro() {
      this.showMainScreen();
    }

    private showMainScreen() {
      this.animationStarted = true;
      
      if (this.hasShownIntro) {
        // 2å›ç›®ä»¥é™ï¼šå³åº§ã«è¡¨ç¤º
        this.introElement.style.display = 'none';
        this.selectionElement.style.opacity = '1';
        this.selectionElement.style.transform = 'translateY(0)';
      } else {
        // åˆå›ï¼šã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãã§é·ç§»
        this.introElement.style.opacity = '0';
        this.introElement.style.transform = 'scale(0.95)';
        
        // é¸æŠç”»é¢ã‚’ã‚¹ãƒ ãƒ¼ã‚ºã«ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³
        setTimeout(() => {
          this.selectionElement.style.opacity = '1';
          this.selectionElement.style.transform = 'translateY(0)';
        }, 200);
        
        // å°å…¥è¦ç´ ã‚’å®Œå…¨ã«å‰Šé™¤
        setTimeout(() => {
          this.introElement.style.display = 'none';
        }, 600);
      }
    }
  }

  // DOMãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã‚‰åˆæœŸåŒ–
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => new IntroAnimationController());
  } else {
    new IntroAnimationController();
  }

  // View Transitions APIå¯¾å¿œ
  document.addEventListener('astro:page-load', () => {
    new IntroAnimationController();
  });
</script>

<style>
  /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
  @media (max-width: 768px) {
    .floating-item {
      font-size: 4rem;
    }
    
    .item-container {
      width: 300px;
      height: 250px;
    }
  }
</style>