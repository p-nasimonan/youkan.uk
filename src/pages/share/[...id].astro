---
import Layout from "../../layouts/Layout.astro";
import { getFileById } from "../../consts/files";

export const prerender = false;

const { id } = Astro.params;

if (!id) {
    return Astro.redirect("/");
}

const fileId = id;
// Find if we have a local definition for this ID
const localFile = getFileById(fileId);

// If local definition exists, use its path. Otherwise fallback to S3 (legacy support or unlisted files)
const fileUrl = localFile
    ? localFile.filePath
    : `https://s3.youkan.uk/misskey/${fileId}`;

const title = localFile ? localFile.title : "Shared File";
const isLocal = !!localFile;
---

<Layout title={`${title} | youkan.uk`}>
    <main>
        <div class="glass-panel content-card">
            <div class="icon-wrapper">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="48"
                    height="48"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                >
                    <path
                        d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"
                    ></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                </svg>
            </div>

            <h1>{title}</h1>
            <p class="file-id">ID: {fileId}</p>

            <div class="preview-container">
                {/* Only show preview if it's an image or we aren't sure */}
                <img
                    src={fileUrl}
                    alt="File Preview"
                    class="file-preview"
                    onerror="this.style.display='none'"
                    style={localFile && !localFile.isImage
                        ? "display: none;"
                        : ""}
                />
            </div>

            <div class="actions">
                <a href={fileUrl} download class="btn primary">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        ><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"
                        ></path><polyline points="7 10 12 15 17 10"
                        ></polyline><line x1="12" y1="15" x2="12" y2="3"
                        ></line></svg
                    >
                    Download File
                </a>
                <button id="copy-btn" class="btn secondary" data-url={fileUrl}>
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        ><rect x="9" y="9" width="13" height="13" rx="2" ry="2"
                        ></rect><path
                            d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"
                        ></path></svg
                    >
                    Copy Link
                </button>
            </div>
        </div>
    </main>
</Layout>

<script>
    const copyBtn = document.getElementById("copy-btn");
    if (copyBtn) {
        copyBtn.addEventListener("click", () => {
            // If data-url is relative, make it absolute for copying
            let url = copyBtn.dataset.url;
            if (url && url.startsWith("/")) {
                url = window.location.origin + url;
            }

            if (url) {
                navigator.clipboard.writeText(url).then(() => {
                    const originalText = copyBtn.innerHTML;
                    copyBtn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
            Copied!
          `;
                    setTimeout(() => {
                        copyBtn.innerHTML = originalText;
                    }, 2000);
                });
            }
        });
    }
</script>

<style>
    main {
        width: 100%;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
    }

    .content-card {
        padding: 3rem;
        text-align: center;
        max-width: 600px;
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1.5rem;
        animation: fadeUp 0.6s ease-out;
    }

    .icon-wrapper {
        background: rgba(255, 255, 255, 0.1);
        padding: 1.5rem;
        border-radius: 50%;
        color: var(--color-secondary);
        box-shadow: 0 0 30px rgba(0, 240, 255, 0.2);
        margin-bottom: 0.5rem;
    }

    h1 {
        font-size: 2.5rem;
        margin: 0;
        font-weight: 700;
    }

    .file-id {
        font-family: monospace;
        color: var(--color-text-muted);
        background: rgba(0, 0, 0, 0.3);
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.9rem;
        word-break: break-all;
    }

    .preview-container {
        width: 100%;
        display: flex;
        justify-content: center;
        margin: 1rem 0;
    }

    .file-preview {
        max-width: 100%;
        max-height: 300px;
        border-radius: 12px;
        border: 1px solid var(--glass-border);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .actions {
        display: flex;
        gap: 1rem;
        width: 100%;
        justify-content: center;
        flex-wrap: wrap;
        margin-top: 1rem;
    }

    .btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.8rem 1.8rem;
        border-radius: 12px;
        font-weight: 600;
        text-decoration: none;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
        font-family: inherit;
        font-size: 1rem;
    }

    .btn.primary {
        background: var(--color-primary);
        color: white;
        box-shadow: 0 4px 15px rgba(123, 97, 255, 0.4);
    }

    .btn.primary:hover {
        background: #6a51e6;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(123, 97, 255, 0.6);
    }

    .btn.secondary {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .btn.secondary:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
    }

    @keyframes fadeUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
